#!/usr/bin/env bun

import { parseAgentArg } from "./agent";
import { runApproveRequirement } from "./commands/approve-requirement";
import { runCreateProjectContext } from "./commands/create-project-context";
import { runDefineRequirement } from "./commands/define-requirement";
import { runDestroy } from "./commands/destroy";
import { runInit } from "./commands/init";
import { runRefineRequirement } from "./commands/refine-requirement";
import { runStartIteration } from "./commands/start-iteration";
import { runWriteJson } from "./commands/write-json";

function parseMode(args: string[]): { mode: "strict" | "yolo"; remainingArgs: string[] } {
  const idx = args.indexOf("--mode");
  if (idx === -1) {
    return { mode: "strict", remainingArgs: args };
  }
  if (idx + 1 >= args.length) {
    throw new Error("Missing value for --mode. Expected: strict or yolo.");
  }

  const mode = args[idx + 1];
  if (mode !== "strict" && mode !== "yolo") {
    throw new Error(`Invalid --mode '${mode}'. Expected: strict or yolo.`);
  }

  const remainingArgs = [...args.slice(0, idx), ...args.slice(idx + 2)];
  return { mode, remainingArgs };
}

function printUsage() {
  console.log(`Usage: nvst <command> [options]

Commands:
  init               Initialize toolkit files in the current directory
  start iteration    Start a new iteration (archives previous if exists)
  create project-context --agent <provider> [--mode strict|yolo]
                     Generate/update .agents/PROJECT_CONTEXT.md via agent
  define requirement --agent <provider>
                     Create requirement document via agent
  refine requirement --agent <provider> [--challenge]
                     Refine requirement document via agent
  approve requirement
                     Mark requirement definition as approved
  write-json --schema <name> --out <path> [--data '<json>']
                     Write a schema-validated JSON file (payload via --data or stdin)
  destroy [--clean]  Remove files generated by nvst

Options:
  --agent            Agent provider (claude, codex, gemini) for agent-backed commands
  --mode             Create mode for project-context (strict or yolo)
  --challenge        Run refine requirement in challenger mode
  --clean            When used with destroy, also removes .agents/flow/archived
  -h, --help         Show this help message`);
}

async function main() {
  const [, , command, ...args] = process.argv;

  if (!command || command === "-h" || command === "--help" || command === "help") {
    printUsage();
    return;
  }

  if (command === "init") {
    if (args.length > 0) {
      console.error(`Unknown option(s) for init: ${args.join(" ")}`);
      printUsage();
      process.exitCode = 1;
      return;
    }
    await runInit();
    return;
  }

  if (command === "destroy") {
    const clean = args.includes("--clean");
    const unknownArgs = args.filter((arg) => arg !== "--clean");
    if (unknownArgs.length > 0) {
      console.error(`Unknown option(s) for destroy: ${unknownArgs.join(" ")}`);
      printUsage();
      process.exitCode = 1;
      return;
    }
    await runDestroy({ clean });
    return;
  }

  if (command === "start") {
    if (args[0] !== "iteration" || args.length !== 1) {
      console.error(`Usage for start: nvst start iteration`);
      printUsage();
      process.exitCode = 1;
      return;
    }
    await runStartIteration();
    return;
  }

  if (command === "create") {
    if (args.length === 0 || args[0] !== "project-context") {
      console.error(
        `Usage for create: nvst create project-context --agent <provider> [--mode strict|yolo]`,
      );
      printUsage();
      process.exitCode = 1;
      return;
    }

    try {
      const { provider, remainingArgs: postAgentArgs } = parseAgentArg(args.slice(1));
      const { mode, remainingArgs: postModeArgs } = parseMode(postAgentArgs);

      if (postModeArgs.length > 0) {
        console.error(`Unknown option(s) for create project-context: ${postModeArgs.join(" ")}`);
        printUsage();
        process.exitCode = 1;
        return;
      }

      await runCreateProjectContext({ provider, mode });
      return;
    } catch (error) {
      console.error(error instanceof Error ? error.message : String(error));
      printUsage();
      process.exitCode = 1;
      return;
    }
  }

  if (command === "define") {
    if (args.length === 0 || args[0] !== "requirement") {
      console.error(`Usage for define: nvst define requirement --agent <provider>`);
      printUsage();
      process.exitCode = 1;
      return;
    }

    try {
      const { provider, remainingArgs: postAgentArgs } = parseAgentArg(args.slice(1));

      if (postAgentArgs.length > 0) {
        console.error(`Unknown option(s) for define requirement: ${postAgentArgs.join(" ")}`);
        printUsage();
        process.exitCode = 1;
        return;
      }

      await runDefineRequirement({ provider });
      return;
    } catch (error) {
      console.error(error instanceof Error ? error.message : String(error));
      printUsage();
      process.exitCode = 1;
      return;
    }
  }

  if (command === "refine") {
    if (args.length === 0 || args[0] !== "requirement") {
      console.error(
        `Usage for refine: nvst refine requirement --agent <provider> [--challenge]`,
      );
      printUsage();
      process.exitCode = 1;
      return;
    }

    try {
      const { provider, remainingArgs: postAgentArgs } = parseAgentArg(args.slice(1));
      const challenge = postAgentArgs.includes("--challenge");
      const unknownArgs = postAgentArgs.filter((arg) => arg !== "--challenge");

      if (unknownArgs.length > 0) {
        console.error(`Unknown option(s) for refine requirement: ${unknownArgs.join(" ")}`);
        printUsage();
        process.exitCode = 1;
        return;
      }

      await runRefineRequirement({ provider, challenge });
      return;
    } catch (error) {
      console.error(error instanceof Error ? error.message : String(error));
      printUsage();
      process.exitCode = 1;
      return;
    }
  }

  if (command === "approve") {
    if (args.length !== 1 || args[0] !== "requirement") {
      console.error(`Usage for approve: nvst approve requirement`);
      printUsage();
      process.exitCode = 1;
      return;
    }

    await runApproveRequirement();
    return;
  }

  if (command === "write-json") {
    await runWriteJson({ args });
    return;
  }

  console.error(`Unknown command: ${command}`);
  printUsage();
  process.exitCode = 1;
}

main().catch((error) => {
  console.error("nvst failed:", error);
  process.exitCode = 1;
});
