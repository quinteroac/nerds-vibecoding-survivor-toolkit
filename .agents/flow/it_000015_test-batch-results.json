[
  {"testCaseId": "TC-001", "status": "passed", "evidence": "src/guardrail.ts lines 76, 66: when violated and relaxed and !force, stderrWriteFn('Warning: ' + message) is called. Unit test guardrail.test.ts 'US-001-AC01: prints Warning to stderr first' asserts stderr.messages[0] equals the warning.", "notes": "Verified by code and existing unit tests."},
  {"testCaseId": "TC-002", "status": "passed", "evidence": "src/guardrail.ts line 84: stderrWriteFn('Proceed anyway? [y/N]') after warning. Unit test 'US-001-AC02: prints Proceed anyway? [y/N] immediately after the warning' expects stderr.messages[1] === 'Proceed anyway? [y/N]'.", "notes": "Exact prompt string verified in code and test."},
  {"testCaseId": "TC-003", "status": "passed", "evidence": "src/guardrail.ts lines 94-95: when line.trim() === 'y' or 'Y' the function returns without throwing. Unit tests 'US-001-AC03: resolves without error when user enters y/Y' and 'does not print Aborted. when confirmed' cover this.", "notes": "Relaxed mode confirm path verified."},
  {"testCaseId": "TC-004", "status": "passed", "evidence": "src/guardrail.ts lines 98-101: else branch sets stderrWriteFn('Aborted.'), process.exitCode = 1, throws GuardrailAbortError. Unit tests 'US-001-AC04: throws GuardrailAbortError when user enters n', 'empty input', 'prints Aborted.', 'sets process.exitCode to 1'.", "notes": "Abort path and no state change (caller exits before side effects) verified."},
  {"testCaseId": "TC-005", "status": "passed", "evidence": "src/guardrail.ts: readLineFn returning null (or throw) leads to line !== 'y'/'Y' branch; lines 98-101 set exitCode 1 and throw GuardrailAbortError. Unit tests 'US-001-AC05: throws GuardrailAbortError when readLineFn returns null', 'prints Aborted.', 'sets process.exitCode to 1', 'treats readLineFn throwing as closed stdin'.", "notes": "Non-TTY/closed stdin behavior verified by tests."},
  {"testCaseId": "TC-006", "status": "passed", "evidence": "src/guardrail.ts uses only stderrWriteFn for warning and prompt; defaultStderrWrite targets process.stderr. Unit test 'US-001-AC06: warning and prompt are sent to stderrWriteFn (stderr), not stdout'.", "notes": "stderr-only output verified."},
  {"testCaseId": "TC-007", "status": "passed", "evidence": "src/guardrail.ts lines 78-80: when force is true, after stderrWriteFn(warning) the function returns without calling readLine or prompting. force-flag.test.ts 'US-002-AC02/AC03: strict mode + --force warns and bypasses prompt' and 'US-002-AC03: relaxed + --force' assert no 'Proceed anyway? [y/N]' in stderr.", "notes": "Verified by code and force-flag tests."},
  {"testCaseId": "TC-008", "status": "passed", "evidence": "With force true, guardrail.ts never enters 'if (guardrail === strict && !force)' so it does not throw; it writes warning and returns (lines 78-80). Unit test 'with force=true and strict: prints warning and continues without throwing' resolves assertGuardrail and checks warning on stderr.", "notes": "Strict + --force proceeds after warning."},
  {"testCaseId": "TC-009", "status": "passed", "evidence": "cli.ts parseForce() strips --force and passes force to runDefineRequirement, runCreatePrototype, runExecuteRefactor, runDefineRefactorPlan, etc. force-flag.test.ts 'US-002-AC04: commands without guardrail ignore --force' runs 'nvst init --force' and expects exitCode 0 and empty stderr.", "notes": "Guarded commands accept --force; init (no guard) does not exit with parse error."},
  {"testCaseId": "TC-010", "status": "passed", "evidence": "scaffold/schemas/tmpl_state.ts line 69: flow_guardrail: z.enum(['strict', 'relaxed']).optional(). Other fields (current_iteration, current_phase, phases, last_updated, updated_by, history) unchanged.", "notes": "Schema inspection; state.test.ts validates both schemas accept strict/relaxed/absent."},
  {"testCaseId": "TC-011", "status": "passed", "evidence": "schemas/state.ts line 71: flow_guardrail: z.enum(['strict', 'relaxed']).optional(). Identical to scaffold. schemas/state.test.ts 'US-003 state schema parity' runs both ScaffoldStateSchema and WorkingCopyStateSchema on same inputs; both accept flow_guardrail strict/relaxed/absent and reject invalid enum.", "notes": "Parity verified by state.test.ts."},
  {"testCaseId": "TC-012", "status": "passed", "evidence": "src/guardrail.ts lines 71-73: if (guardrail === 'strict' && !force) throw new Error(message). No prompt in strict. Unit test 'US-003-AC03: strict mode throws the same violation message and never prompts' asserts reject with message and promptCalled false.", "notes": "Strict violation throws same message, no prompt."},
  {"testCaseId": "TC-013", "status": "passed", "evidence": "src/guardrail.ts line 66: const guardrail = state.flow_guardrail ?? 'strict'. Unit test 'US-003-AC04: absent flow_guardrail defaults to strict hard-error behavior' uses makeState(undefined) and expects throw and prompt not called.", "notes": "Absent defaults to strict."},
  {"testCaseId": "TC-014", "status": "passed", "evidence": "StateSchema in scaffold and schemas use .optional() for flow_guardrail. state.ts readState uses StateSchema.safeParse(json). .agents/state.json has no flow_guardrail key; state.test.ts 'both schemas accept state without flow_guardrail' passes makeValidState() with no flow_guardrail.", "notes": "Existing state parses; test and repo state.json confirm."},
  {"testCaseId": "TC-015", "status": "passed", "evidence": "src/guardrail.ts exports assertGuardrail(state: State, violated: boolean, message: string, opts: GuardrailOptions = {}) with GuardrailOptions { force?: boolean; readLineFn?; stderrWriteFn? }. Equivalent to (state, condition, message, options: { force }) per test plan.", "notes": "Exported function with expected signature in src/guardrail.ts."},
  {"testCaseId": "TC-016", "status": "passed", "evidence": "src/guardrail.ts lines 71-73: when guardrail === 'strict' and !force, throw new Error(message). Unit tests 'strict mode throws the same violation message' and 'throws Error (not GuardrailAbortError) in strict mode' verify.", "notes": "Strict and force false throws."},
  {"testCaseId": "TC-017", "status": "passed", "evidence": "Relaxed and !force: lines 76, 84 write warning and prompt; lines 86-95 await readLine; y/Y return; else 98-101 stderr 'Aborted.', exitCode 1, throw GuardrailAbortError. Unit tests cover warning+prompt, confirm no throw, deny sets exitCode 1 and Aborted.", "notes": "Relaxed behavior and stdin confirm/deny verified in guardrail.test.ts."},
  {"testCaseId": "TC-018", "status": "passed", "evidence": "src/guardrail.ts lines 78-80: if (force) return after stderrWriteFn(warning). No prompt, no throw. Unit test 'with force=true and relaxed: prints warning but does not prompt or abort' asserts warning present, prompt and Aborted. absent, exitCode falsy.", "notes": "Force true: warn only, no prompt, no throw."},
  {"testCaseId": "TC-019", "status": "passed", "evidence": "define-requirement.ts, create-prototype.ts, execute-refactor.ts, define-refactor-plan.ts import and call assertGuardrail for phase/status checks. Grep shows no inline 'throw new Error' for phase messages in these files; phase violations use assertGuardrail only.", "notes": "All listed commands use assertGuardrail; no inline phase throw."},
  {"testCaseId": "TC-020", "status": "passed", "evidence": "Grep for phase/current_phase guard messages in src/commands: define-requirement (assertGuardrail), create-prototype (assertGuardrail), execute-refactor (assertGuardrail), define-refactor-plan (assertGuardrail). Other 'throw new Error' in commands are for missing files, agent failures, or non-phase validation.", "notes": "No inline phase-guard throw; all route through assertGuardrail."}
]
