{
  "iteration": "000015",
  "testPlanFile": "it_000015_TP.json",
  "executedTestIds": [
    "TC-001",
    "TC-002",
    "TC-003",
    "TC-004",
    "TC-005",
    "TC-006",
    "TC-007",
    "TC-008",
    "TC-009",
    "TC-010",
    "TC-011",
    "TC-012",
    "TC-013",
    "TC-014",
    "TC-015",
    "TC-016",
    "TC-017",
    "TC-018",
    "TC-019",
    "TC-020"
  ],
  "results": [
    {
      "testCaseId": "TC-001",
      "description": "When phase/status violation is detected and `flow_guardrail` is `\"relaxed\"` (no `--force`), the command prints a warning to stderr describing the violation.",
      "correlatedRequirements": [
        "US-001",
        "FR-3",
        "FR-6"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 76, 66: when violated and relaxed and !force, stderrWriteFn('Warning: ' + message) is called. Unit test guardrail.test.ts 'US-001-AC01: prints Warning to stderr first' asserts stderr.messages[0] equals the warning.",
        "notes": "Verified by code and existing unit tests."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-001_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002",
      "description": "After the warning in relaxed mode, the command prints exactly `Proceed anyway? [y/N]` to stderr.",
      "correlatedRequirements": [
        "US-001",
        "FR-4",
        "FR-6"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts line 84: stderrWriteFn('Proceed anyway? [y/N]') after warning. Unit test 'US-001-AC02: prints Proceed anyway? [y/N] immediately after the warning' expects stderr.messages[1] === 'Proceed anyway? [y/N]'.",
        "notes": "Exact prompt string verified in code and test."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-002_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003",
      "description": "In relaxed mode, when user enters `y` or `Y` and Enter, the command continues (no exit, no \"Aborted.\").",
      "correlatedRequirements": [
        "US-001",
        "FR-4"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 94-95: when line.trim() === 'y' or 'Y' the function returns without throwing. Unit tests 'US-001-AC03: resolves without error when user enters y/Y' and 'does not print Aborted. when confirmed' cover this.",
        "notes": "Relaxed mode confirm path verified."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-003_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-004",
      "description": "In relaxed mode, when user enters `n`, empty line, or other input and Enter, the command exits with `process.exitCode = 1`, prints `Aborted.` to stderr, and makes no changes to state or files.",
      "correlatedRequirements": [
        "US-001",
        "FR-4"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 98-101: else branch sets stderrWriteFn('Aborted.'), process.exitCode = 1, throws GuardrailAbortError. Unit tests 'US-001-AC04: throws GuardrailAbortError when user enters n', 'empty input', 'prints Aborted.', 'sets process.exitCode to 1'.",
        "notes": "Abort path and no state change (caller exits before side effects) verified."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-004_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-005",
      "description": "In relaxed mode without `--force`, when stdin is closed or not a TTY, the command exits with code 1, prints `Aborted.` to stderr, and does not modify state or files.",
      "correlatedRequirements": [
        "US-001",
        "FR-4"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts: readLineFn returning null (or throw) leads to line !== 'y'/'Y' branch; lines 98-101 set exitCode 1 and throw GuardrailAbortError. Unit tests 'US-001-AC05: throws GuardrailAbortError when readLineFn returns null', 'prints Aborted.', 'sets process.exitCode to 1', 'treats readLineFn throwing as closed stdin'.",
        "notes": "Non-TTY/closed stdin behavior verified by tests."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-005_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-006",
      "description": "Warning and confirmation prompt are written to stderr only; normal command output remains on stdout.",
      "correlatedRequirements": [
        "US-001",
        "FR-6"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts uses only stderrWriteFn for warning and prompt; defaultStderrWrite targets process.stderr. Unit test 'US-001-AC06: warning and prompt are sent to stderrWriteFn (stderr), not stdout'.",
        "notes": "stderr-only output verified."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-006_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-007",
      "description": "With `--force` and a phase/status violation, the command prints the warning to stderr but does not show the confirmation prompt and proceeds.",
      "correlatedRequirements": [
        "US-002",
        "FR-3",
        "FR-5"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 78-80: when force is true, after stderrWriteFn(warning) the function returns without calling readLine or prompting. force-flag.test.ts 'US-002-AC02/AC03: strict mode + --force warns and bypasses prompt' and 'US-002-AC03: relaxed + --force' assert no 'Proceed anyway? [y/N]' in stderr.",
        "notes": "Verified by code and force-flag tests."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-007_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-008",
      "description": "With `--force` and `flow_guardrail` `\"strict\"`, a phase violation does not throw; command proceeds after warning.",
      "correlatedRequirements": [
        "US-002",
        "FR-5"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "With force true, guardrail.ts never enters 'if (guardrail === strict && !force)' so it does not throw; it writes warning and returns (lines 78-80). Unit test 'with force=true and strict: prints warning and continues without throwing' resolves assertGuardrail and checks warning on stderr.",
        "notes": "Strict + --force proceeds after warning."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-008_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-009",
      "description": "Commands that perform phase/status validation accept `--force` in argv and forward it to `assertGuardrail`; commands without guardrail ignore unknown flags and do not exit with parse error.",
      "correlatedRequirements": [
        "US-002",
        "FR-5",
        "FR-7"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "cli.ts parseForce() strips --force and passes force to runDefineRequirement, runCreatePrototype, runExecuteRefactor, runDefineRefactorPlan, etc. force-flag.test.ts 'US-002-AC04: commands without guardrail ignore --force' runs 'nvst init --force' and expects exitCode 0 and empty stderr.",
        "notes": "Guarded commands accept --force; init (no guard) does not exit with parse error."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-009_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-010",
      "description": "`StateSchema` in `scaffold/schemas/tmpl_state.ts` accepts optional top-level `flow_guardrail: z.enum([\"strict\", \"relaxed\"]).optional()`; existing fields unchanged.",
      "correlatedRequirements": [
        "US-003",
        "FR-1"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "scaffold/schemas/tmpl_state.ts line 69: flow_guardrail: z.enum(['strict', 'relaxed']).optional(). Other fields (current_iteration, current_phase, phases, last_updated, updated_by, history) unchanged.",
        "notes": "Schema inspection; state.test.ts validates both schemas accept strict/relaxed/absent."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-010_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-011",
      "description": "The schema copy in `schemas/` matches the `flow_guardrail` definition in `scaffold/schemas/tmpl_state.ts`.",
      "correlatedRequirements": [
        "US-003",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "schemas/state.ts line 71: flow_guardrail: z.enum(['strict', 'relaxed']).optional(). Identical to scaffold. schemas/state.test.ts 'US-003 state schema parity' runs both ScaffoldStateSchema and WorkingCopyStateSchema on same inputs; both accept flow_guardrail strict/relaxed/absent and reject invalid enum.",
        "notes": "Parity verified by state.test.ts."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-011_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-012",
      "description": "When `flow_guardrail` is `\"strict\"` and a violation is detected (no `--force`), the command throws an `Error` with the same message as before (no prompt).",
      "correlatedRequirements": [
        "US-003",
        "FR-2",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 71-73: if (guardrail === 'strict' && !force) throw new Error(message). No prompt in strict. Unit test 'US-003-AC03: strict mode throws the same violation message and never prompts' asserts reject with message and promptCalled false.",
        "notes": "Strict violation throws same message, no prompt."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-012_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-013",
      "description": "When `flow_guardrail` is absent, behavior defaults to `\"strict\"` (hard error, no prompt).",
      "correlatedRequirements": [
        "US-003",
        "FR-2"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts line 66: const guardrail = state.flow_guardrail ?? 'strict'. Unit test 'US-003-AC04: absent flow_guardrail defaults to strict hard-error behavior' uses makeState(undefined) and expects throw and prompt not called.",
        "notes": "Absent defaults to strict."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-013_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-014",
      "description": "Existing `state.json` without `flow_guardrail` parses successfully.",
      "correlatedRequirements": [
        "US-003",
        "FR-1"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "StateSchema in scaffold and schemas use .optional() for flow_guardrail. state.ts readState uses StateSchema.safeParse(json). .agents/state.json has no flow_guardrail key; state.test.ts 'both schemas accept state without flow_guardrail' passes makeValidState() with no flow_guardrail.",
        "notes": "Existing state parses; test and repo state.json confirm."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-014_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-015",
      "description": "A new exported function (e.g. `assertGuardrail(state, condition, message, options: { force: boolean })`) exists in `src/guardrail.ts`.",
      "correlatedRequirements": [
        "US-004",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts exports assertGuardrail(state: State, violated: boolean, message: string, opts: GuardrailOptions = {}) with GuardrailOptions { force?: boolean; readLineFn?; stderrWriteFn? }. Equivalent to (state, condition, message, options: { force }) per test plan.",
        "notes": "Exported function with expected signature in src/guardrail.ts."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-015_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-016",
      "description": "`assertGuardrail`: when effective mode is strict and `force` is false, it throws.",
      "correlatedRequirements": [
        "US-004",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 71-73: when guardrail === 'strict' and !force, throw new Error(message). Unit tests 'strict mode throws the same violation message' and 'throws Error (not GuardrailAbortError) in strict mode' verify.",
        "notes": "Strict and force false throws."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-016_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-017",
      "description": "`assertGuardrail`: when effective mode is relaxed and `force` is false, it writes warning and prompt to stderr and (when stdin confirms) does not throw; when stdin denies, caller exits with code 1.",
      "correlatedRequirements": [
        "US-004",
        "FR-3",
        "FR-4"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "Relaxed and !force: lines 76, 84 write warning and prompt; lines 86-95 await readLine; y/Y return; else 98-101 stderr 'Aborted.', exitCode 1, throw GuardrailAbortError. Unit tests cover warning+prompt, confirm no throw, deny sets exitCode 1 and Aborted.",
        "notes": "Relaxed behavior and stdin confirm/deny verified in guardrail.test.ts."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-017_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-018",
      "description": "`assertGuardrail`: when `force` is true, it writes warning to stderr and does not prompt; does not throw.",
      "correlatedRequirements": [
        "US-004",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "src/guardrail.ts lines 78-80: if (force) return after stderrWriteFn(warning). No prompt, no throw. Unit test 'with force=true and relaxed: prints warning but does not prompt or abort' asserts warning present, prompt and Aborted. absent, exitCode falsy.",
        "notes": "Force true: warn only, no prompt, no throw."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-018_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-019",
      "description": "Commands `define-requirement`, `create-prototype`, `execute-refactor`, `define-refactor-plan` (and any other with phase guard) call `assertGuardrail` for phase/status checks and do not inline `throw new Error(...)` for phase guards.",
      "correlatedRequirements": [
        "US-004",
        "FR-7"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-requirement.ts, create-prototype.ts, execute-refactor.ts, define-refactor-plan.ts import and call assertGuardrail for phase/status checks. Grep shows no inline 'throw new Error' for phase messages in these files; phase violations use assertGuardrail only.",
        "notes": "All listed commands use assertGuardrail; no inline phase throw."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-019_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-020",
      "description": "No command retains an inline phase-guard `throw`; all phase violations route through `assertGuardrail`.",
      "correlatedRequirements": [
        "US-004",
        "FR-7"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "Grep for phase/current_phase guard messages in src/commands: define-requirement (assertGuardrail), create-prototype (assertGuardrail), execute-refactor (assertGuardrail), define-refactor-plan (assertGuardrail). Other 'throw new Error' in commands are for missing files, agent failures, or non-phase validation.",
        "notes": "No inline phase-guard throw; all route through assertGuardrail."
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000015_test-execution-artifacts/TC-020_attempt_001.json"
      ]
    }
  ]
}
