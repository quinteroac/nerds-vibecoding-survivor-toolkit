{
  "overallStatus": "pending",
  "scope": [
    "Interactive dirty-tree flow in `runCreatePrototype`: prompt on uncommitted changes instead of throwing, optional auto-commit on confirm, clean exit on decline.",
    "New dependency-injection fields `confirmFn` and `gitAddAndCommitFn` on `CreatePrototypeDeps`, their default behaviour and non-interactive (non-TTY) handling.",
    "Unit and integration coverage for confirm path, decline path, and git commit failure path; typecheck and existing test suite remain passing."
  ],
  "environmentData": [
    "Runtime: Bun (v1+); tests executed with `bun test`; typecheck with `bun tsc --noEmit`.",
    "Unit tests use mocks for `confirmFn`, `gitAddAndCommitFn`, and (where needed) state I/O; integration tests may use a temporary git repo with uncommitted changes.",
    "Test files: co-located `src/commands/create-prototype.test.ts` (or equivalent) for unit/command tests; `tests/**/*.test.ts` for workflow/integration if needed.",
    "No external services required; git must be available for integration tests that run real `git add` / `git commit`.",
    "---",
    "## User Story: US-001 - Prompt on dirty working tree instead of throwing"
  ],
  "automatedTests": [
    {
      "id": "TC-001",
      "description": "When the phase-transition dirty-tree check detects uncommitted changes, the command invokes confirmFn with the message containing \"Working tree has uncommitted changes. Stage and commit them now to proceed? [y/N]\".",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-3"
      ]
    },
    {
      "id": "TC-002",
      "description": "When the post-transition dirty-tree check detects uncommitted changes, the command invokes confirmFn with the same prompt message.",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-4"
      ]
    },
    {
      "id": "TC-003",
      "description": "Default confirmFn (or a mock simulating it): trimmed stdin line \"y\" or \"Y\" returns true.",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-1"
      ]
    },
    {
      "id": "TC-004",
      "description": "Default confirmFn (or mock): input other than \"y\"/\"Y\", or empty line, is treated as No (return false).",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-1"
      ]
    },
    {
      "id": "TC-005",
      "description": "When stdin is not a TTY (or confirmFn simulates non-TTY), confirmFn returns false immediately without waiting for input.",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-6"
      ]
    },
    {
      "id": "TC-006",
      "description": "Codebase does not contain the old hard-error string \"Git working tree is dirty. Commit your changes\" at the two previous check sites.",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-3",
        "FR-4"
      ]
    },
    {
      "id": "TC-007",
      "description": "Typecheck passes after implementation (`bun tsc --noEmit`).",
      "status": "pending",
      "correlatedRequirements": [
        "US-001",
        "FR-1",
        "FR-2"
      ]
    },
    {
      "id": "TC-008",
      "description": "On confirm (confirmFn returns true), gitAddAndCommitFn is invoked with cwd equal to the project root and message \"chore: pre-prototype commit it_&lt;iteration&gt;\" where &lt;iteration&gt; is state.current_iteration.",
      "status": "pending",
      "correlatedRequirements": [
        "US-002",
        "FR-2",
        "FR-5"
      ]
    },
    {
      "id": "TC-009",
      "description": "When gitAddAndCommitFn rejects (e.g. pre-commit hook failure), the handler throws an Error whose message starts with \"Pre-prototype commit failed:\" and includes stderr; process.exitCode is set to 1 by CLI layer.",
      "status": "pending",
      "correlatedRequirements": [
        "US-002",
        "FR-3"
      ]
    },
    {
      "id": "TC-010",
      "description": "After a successful gitAddAndCommitFn resolve, the prototype build continues (no second dirty-tree error); state transition and build flow proceed.",
      "status": "pending",
      "correlatedRequirements": [
        "US-002",
        "FR-3",
        "FR-4"
      ]
    },
    {
      "id": "TC-011",
      "description": "Typecheck passes.",
      "status": "pending",
      "correlatedRequirements": [
        "US-002"
      ]
    },
    {
      "id": "TC-012",
      "description": "On decline (confirmFn returns false), the handler logs the abort message containing \"Aborted. Commit or discard your changes and re-run \\`bun nvst create prototype\\`.\" and returns without throwing.",
      "status": "pending",
      "correlatedRequirements": [
        "US-003",
        "FR-3",
        "FR-4"
      ]
    },
    {
      "id": "TC-013",
      "description": "On decline, process.exitCode is not set to 1 (clean exit).",
      "status": "pending",
      "correlatedRequirements": [
        "US-003"
      ]
    },
    {
      "id": "TC-014",
      "description": "On decline, no state changes are written to .agents/state.json (state write functions not called, or state file unchanged).",
      "status": "pending",
      "correlatedRequirements": [
        "US-003"
      ]
    },
    {
      "id": "TC-015",
      "description": "Typecheck passes.",
      "status": "pending",
      "correlatedRequirements": [
        "US-003"
      ]
    },
    {
      "id": "TC-016",
      "description": "Confirm path: mock confirmFn returns true; mock gitAddAndCommitFn is called with the correct commit message; no error thrown; build continues (e.g. next step or return value indicates progression).",
      "status": "pending",
      "correlatedRequirements": [
        "US-004",
        "FR-3",
        "FR-5"
      ]
    },
    {
      "id": "TC-017",
      "description": "Decline path: mock confirmFn returns false; gitAddAndCommitFn is never called; handler returns cleanly (no throw).",
      "status": "pending",
      "correlatedRequirements": [
        "US-004",
        "FR-3",
        "FR-4"
      ]
    },
    {
      "id": "TC-018",
      "description": "Git commit failure path: confirmFn returns true; gitAddAndCommitFn rejects with stderr; handler throws an error whose message includes \"Pre-prototype commit failed\" and stderr.",
      "status": "pending",
      "correlatedRequirements": [
        "US-004",
        "FR-3"
      ]
    },
    {
      "id": "TC-019",
      "description": "All tests in the project pass (`bun test`); existing create-prototype tests that hit the dirty-tree path use an injected confirmFn (e.g. returning false) so they still pass.",
      "status": "pending",
      "correlatedRequirements": [
        "US-004",
        "FR-7"
      ]
    },
    {
      "id": "TC-020",
      "description": "Typecheck passes.",
      "status": "pending",
      "correlatedRequirements": [
        "US-004"
      ]
    }
  ],
  "exploratoryManualTests": []
}
