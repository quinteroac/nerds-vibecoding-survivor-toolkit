{
  "iteration": "000013",
  "testPlanFile": "it_000013_TP.json",
  "executedTestIds": [
    "TC-001-01",
    "TC-001-02",
    "TC-001-03",
    "TC-001-04",
    "TC-001-05",
    "TC-001-06",
    "TC-001-07",
    "TC-001-08",
    "TC-001-09",
    "TC-002-01",
    "TC-002-02",
    "TC-002-03",
    "TC-002-04",
    "TC-002-05",
    "TC-002-06",
    "TC-002-07",
    "TC-002-08",
    "TC-002-09",
    "TC-002-10",
    "TC-002-11",
    "TC-003-01",
    "TC-003-02",
    "TC-003-03",
    "TC-003-04",
    "TC-003-05",
    "TC-003-06",
    "TC-003-07",
    "TC-003-08",
    "TC-003-09",
    "TC-003-10",
    "TC-003-11",
    "TC-003-12"
  ],
  "results": [
    {
      "testCaseId": "TC-001-01",
      "description": "Command handler rejects when `current_phase` is not `\"refactor\"` (e.g. `\"prototype\"`)",
      "correlatedRequirements": [
        "US-001",
        "FR-7",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-refactor-plan.test.ts rejects when currentPhase is prototype; define-refactor-plan.ts throws when current_phase !== 'refactor'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-01_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-02",
      "description": "Command handler rejects when `refactor.refactor_plan.status` is not `\"pending\"` (e.g. `\"pending_approval\"`)",
      "correlatedRequirements": [
        "US-001",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-refactor-plan.test.ts rejects when refactorPlanStatus is approved; handler throws when refactor_plan.status !== 'pending'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-02_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-03",
      "description": "Skill is loaded from `.agents/skills/plan-refactor/SKILL.md` and `buildPrompt` receives `{ current_iteration }`",
      "correlatedRequirements": [
        "US-001",
        "FR-1"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-refactor-plan.test.ts loads skill 'plan-refactor' and prompt contains 'current_iteration' and '000013'; loadSkillFn(projectRoot, 'plan-refactor') and buildPrompt(skillBody, { current_iteration }).",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-03_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-04",
      "description": "`invokeAgent` is called with `interactive: true`",
      "correlatedRequirements": [
        "US-001",
        "FR-1"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-refactor-plan.test.ts expects invocation.interactive === true; invokeAgentFn called with interactive: true in define-refactor-plan.ts.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-04_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-05",
      "description": "On agent `exitCode === 0`, `refactor_plan.status` is set to `\"pending_approval\"` and `refactor_plan.file` to `\"it_000013_refactor-plan.md\"`",
      "correlatedRequirements": [
        "US-001",
        "FR-1"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-refactor-plan.test.ts asserts refactor_plan.status === 'pending_approval' and refactor_plan.file === 'it_000013_refactor-plan.md' after agent exitCode 0.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-05_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-06",
      "description": "On agent success, `state.last_updated` and `state.updated_by` are set to `\"nvst:define-refactor-plan\"` and `writeState` is called once",
      "correlatedRequirements": [
        "US-001",
        "FR-1",
        "FR-7"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "define-refactor-plan.test.ts asserts state.last_updated and state.updated_by === 'nvst:define-refactor-plan'; define-refactor-plan.ts calls writeState(projectRoot, state) once on success.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-06_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-07",
      "description": "`src/cli.ts` routes `[\"define\", \"refactor-plan\"]` to the `runDefineRefactorPlan` handler",
      "correlatedRequirements": [
        "US-001",
        "FR-1"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "cli.ts: command === 'define', subcommand === 'refactor-plan' dispatches to runDefineRefactorPlan({ provider }); define-refactor-plan.test.ts checks cli.ts contains runDefineRefactorPlan and refactor-plan.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-07_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-08",
      "description": "Handler does not call `process.exit()` under any code path",
      "correlatedRequirements": [
        "US-001",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "Grep on src/commands/define-refactor-plan.ts: zero occurrences of process.exit(.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-08_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-001-09",
      "description": "`.agents/skills/plan-refactor/SKILL.md` contains required structure: objectives, inputs, output filename pattern, `## Refactor Items` section, `### RI-NNN: <Title>` subsection format, `**Description:**` and `**Rationale:**` fields",
      "correlatedRequirements": [
        "US-001",
        "FR-9"
      ],
      "mode": "automated",
      "payload": {
        "status": "failed",
        "evidence": ".agents/skills/plan-refactor/SKILL.md contains only TBD placeholders; missing ## Refactor Items, ### RI-NNN: <Title>, **Description:**, **Rationale:** structure.",
        "notes": "FR-9 requires the skill to include the stated structure; file has Objective/Inputs/Outputs but no Refactor Items section or subsection format."
      },
      "passFail": "fail",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-001-09_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-01",
      "description": "Command handler rejects when `refactor.refactor_plan.status` is not `\"pending_approval\"`",
      "correlatedRequirements": [
        "US-002",
        "FR-2",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts requires status pending_approval and rejects when status is approved; handler throws when refactor_plan.status !== 'pending_approval'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-01_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-02",
      "description": "Command handler rejects when `refactor_plan.file` is missing from state",
      "correlatedRequirements": [
        "US-002",
        "FR-2",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts rejects when refactor_plan.file is null; handler throws 'refactor.refactor_plan.file is missing.'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-02_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-03",
      "description": "Command handler rejects when `refactor_plan.file` points to a non-existent file on disk",
      "correlatedRequirements": [
        "US-002",
        "FR-2",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts rejects when plan file does not exist on disk; handler throws 'file not found at'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-03_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-04",
      "description": "Skill is loaded from `.agents/skills/refine-refactor-plan/SKILL.md`",
      "correlatedRequirements": [
        "US-002",
        "FR-2",
        "FR-4"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts expects loadedSkill === 'refine-refactor-plan'; loadSkillFn(projectRoot, 'refine-refactor-plan') resolves to .agents/skills/refine-refactor-plan/SKILL.md.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-04_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-05",
      "description": "Prompt context includes `current_iteration`, `refactor_plan_file`, and `refactor_plan_content` (content of the plan file)",
      "correlatedRequirements": [
        "US-002",
        "FR-2"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts asserts prompt contains current_iteration, refactor_plan_file, refactor_plan_content and plan file content; refine-refactor-plan.ts builds context with current_iteration, refactor_plan_file, refactor_plan_content.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-05_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-06",
      "description": "Without `--challenge` flag, `context.mode` is absent from the prompt context",
      "correlatedRequirements": [
        "US-002",
        "FR-2"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.ts sets context.mode only when challenge is true; without --challenge, context has no mode key.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-06_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-07",
      "description": "With `--challenge` flag, `context.mode = \"challenger\"` is included in the prompt context",
      "correlatedRequirements": [
        "US-002",
        "FR-2"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts 'passes mode=challenger when challenge mode is enabled' asserts invocationPrompt contains '### mode' and 'challenger'; context.mode = 'challenger' when challenge is true.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-07_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-08",
      "description": "State is not mutated after agent invocation (status stays `\"pending_approval\"`)",
      "correlatedRequirements": [
        "US-002",
        "FR-2"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "refine-refactor-plan.test.ts compares stateBefore and stateAfter JSON; state unchanged after runRefineRefactorPlan (status remains pending_approval).",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-08_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-09",
      "description": "`src/cli.ts` routes `[\"refine\", \"refactor-plan\"]` to the `runRefineRefactorPlan` handler and passes `challenge: true` when `--challenge` is present",
      "correlatedRequirements": [
        "US-002",
        "FR-2"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "cli.ts: refine refactor-plan branch sets challenge = postAgentArgs.includes('--challenge') and calls runRefineRefactorPlan({ provider, challenge }); refine-refactor-plan.test.ts checks cli.ts for runRefineRefactorPlan and --challenge.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-09_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-10",
      "description": "Handler does not call `process.exit()` under any code path",
      "correlatedRequirements": [
        "US-002",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "Grep on src/commands/refine-refactor-plan.ts: zero occurrences of process.exit(.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-10_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-002-11",
      "description": "`.agents/skills/refine-refactor-plan/SKILL.md` exists and contains instructions for both edit and challenge modes",
      "correlatedRequirements": [
        "US-002",
        "FR-4"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": ".agents/skills/refine-refactor-plan/SKILL.md exists; content includes 'Editor mode' and 'Challenger mode' (edit and challenge instructions).",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-002-11_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-01",
      "description": "Command handler rejects when `refactor.refactor_plan.status` is not `\"pending_approval\"`",
      "correlatedRequirements": [
        "US-003",
        "FR-3",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts requires status pending_approval and rejects when status is pending; handler throws when refactor_plan.status !== 'pending_approval'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-01_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-02",
      "description": "Command handler rejects when `refactor_plan.file` is missing from state",
      "correlatedRequirements": [
        "US-003",
        "FR-3",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts rejects when refactor_plan.file is null; handler throws 'refactor.refactor_plan.file is missing.'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-02_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-03",
      "description": "Command handler rejects when `refactor_plan.file` points to a non-existent file on disk",
      "correlatedRequirements": [
        "US-003",
        "FR-3",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts rejects when plan file does not exist; handler throws 'file not found at'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-03_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-04",
      "description": "`RefactorPrdSchema` accepts a valid object with `refactorItems` array where each item has `id` (`RI-NNN` format), `title`, `description`, and `rationale`",
      "correlatedRequirements": [
        "US-003",
        "FR-5"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts validates RefactorPrdSchema.safeParse(parsedPayload) success and refactorItems with id (RI-NNN), title, description, rationale; tmpl_refactor-prd.ts defines RefactorItemSchema with those fields.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-04_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-05",
      "description": "`RefactorPrdSchema` rejects objects missing any required field (`id`, `title`, `description`, or `rationale`)",
      "correlatedRequirements": [
        "US-003",
        "FR-5"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "RefactorPrdSchema uses z.object with required id, title, description, rationale (z.string().min(1) or regex); safeParse returns success: false for missing fields.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-05_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-06",
      "description": "`RefactorPrdSchema` rejects items where `id` does not match `RI-NNN` format (e.g. `\"RI-1\"`, `\"R-001\"`, `\"\"`)",
      "correlatedRequirements": [
        "US-003",
        "FR-5"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "RefactorPrdSchema id: z.string().regex(/^RI-\\\\d{3}$/); rejects RI-1, R-001, empty string.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-06_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-07",
      "description": "`nvst write-json --schema refactor-prd` resolves `RefactorPrdSchema` without throwing a \"schema not found\" error",
      "correlatedRequirements": [
        "US-003",
        "FR-6"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "write-json.ts SCHEMA_REGISTRY has 'refactor-prd': RefactorPrdSchema; schema lookup does not throw 'schema not found'.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-07_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-08",
      "description": "If `write-json` subprocess exits with non-zero code, state is NOT mutated and command exits with `process.exitCode = 1`",
      "correlatedRequirements": [
        "US-003",
        "FR-3",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts 'prints an error and keeps refactor plan pending_approval when write-json fails' asserts process.exitCode === 1 and state unchanged (status pending_approval, updated_by 'seed').",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-08_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-09",
      "description": "On `write-json` success, `refactor_plan.status` is set to `\"approved\"` and state is persisted via `writeState`",
      "correlatedRequirements": [
        "US-003",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts asserts refactor_plan.status === 'approved' and state persisted after write-json success; handler sets status to approved and calls writeState.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-09_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-10",
      "description": "On success, `state.last_updated` is refreshed and `state.updated_by` is set to `\"nvst:approve-refactor-plan\"`",
      "correlatedRequirements": [
        "US-003",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "approve-refactor-plan.test.ts asserts state.last_updated and state.updated_by === 'nvst:approve-refactor-plan' on success.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-10_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-11",
      "description": "`src/cli.ts` routes `[\"approve\", \"refactor-plan\"]` to the `runApproveRefactorPlan` handler",
      "correlatedRequirements": [
        "US-003",
        "FR-3"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "cli.ts: approve refactor-plan dispatches to runApproveRefactorPlan(); approve-refactor-plan.test.ts checks cli.ts contains runApproveRefactorPlan and refactor-plan.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-11_attempt_001.json"
      ]
    },
    {
      "testCaseId": "TC-003-12",
      "description": "Handler does not call `process.exit()` under any code path",
      "correlatedRequirements": [
        "US-003",
        "FR-8"
      ],
      "mode": "automated",
      "payload": {
        "status": "passed",
        "evidence": "Grep on src/commands/approve-refactor-plan.ts: zero occurrences of process.exit(.",
        "notes": ""
      },
      "passFail": "pass",
      "agentExitCode": 0,
      "artifactReferences": [
        ".agents/flow/it_000013_test-execution-artifacts/TC-003-12_attempt_001.json"
      ]
    }
  ]
}
